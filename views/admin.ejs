<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#0d6efd">
    <!-- Bootstrap -->

    <link href="/stylesheets/bootstrap.css" rel="stylesheet" type="text/css">
    <link rel='stylesheet' type="text/css" href='/stylesheets/style.css' />

    <link href="/stylesheets/bootstrap-grid.css" rel="stylesheet" type="text/css">
    <!-- <script src="https://kit.fontawesome.com/794501ab65.js" crossorigin="anonymous"></script> -->
    <link rel='stylesheet' href='/stylesheets/lib.css' />

    <!-- Font awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" integrity="sha512-HK5fgLBL+xu6dm/Ii3z4xhlSUyZgTT9tuc/hSrtw6uzJOvgRr2a9jyxxT1ely+B+xFAmJKVSTbpM/CuL7qxO8w==" crossorigin="anonymous" />
    <link rel="shortcut icon" href="images/favicon.png" type="image/x-icon">
    <title>Admin</title>

    <style>
        form .requiredX {
            position: relative;
            top: 5px;
        }
        
        #register,
        #login {
            margin-top: 70px;
        }
        
        form p {
            font-size: 18px;
        }
        
        .good,
        .better,
        .best {
            width: 22%;
            height: 10px;
            position: relative;
            transition: background .3s;
        }
        
        @media only screen and (min-width: 576px) {
            form {
                width: 50% !important
            }
            #register,
            #login {
                margin-top: 100px !important;
            }
            form p {
                font-size: 20px;
            }
            .good,
            .better,
            .best {
                width: 25%;
            }
        }
    </style>
</head>

<body>
    <!-- Navbar start-->
    <nav class="navbar navbar-expand-md navbar-light fixed-top py-0 shadow">
        <div class=" container ps-lg-5">
            <a class="text-35 navbar-brand text-primary " href="/ ">
                         Yowa Music
                     </a>
            <button class="navbar-toggler ml-20" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
       <span class="navbar-toggler-icon"></span>
     </button>
            <div class="collapse justify-content-end navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ">
                    <li class="nav-item text-20">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item text-20">
                        <a class="nav-link" aria-current="page" href="/songs">Songs</a>
                    </li>
                    <li class="nav-item text-20">
                        <a class="nav-link" href="/gallery">Gallery</a>
                    </li>

                </ul>
            </div>
        </div>
    </nav>


    <section id="login" class="d-none d-flex justify-content-center align-items-center container px-5">
        <form action="/admin" method="POST" name="login">
            <h1 class="text-center mb-3 mt-4">Login your account</h1>
            <fieldset>
                <h2 class="text-danger text-center" id="noUser"></h2>
                <div class="form-group mt-3">
                    <label for="email" class="text-20">Email<span class="requiredX text-danger"> *</span></label>
                    <input type="email" name="email" class="mb-2 form-control" id="email" aria-describedby="emailHelp" placeholder="Enter your email" required>

                </div>

                <div class="form-group mt-3">
                    <label for="password" class="text-20">Password<span class="requiredX text-danger"> *</span></label>
                    <input type="password" name="password" class="form-control" id="password" aria-describedby="password" placeholder="Enter your password" required>
                    <small id="loginErr" class="text-danger text-18"></small>
                </div>

                <button type="submit" class="btn btn-primary w-100 mt-4 text-20" name="submit">Log in</button>
            </fieldset>

            <p class="text-center mt-4">Don't have an account, <a href="#" class="text-decoration-none border-danger border-bottom border-2 text-pink">Create one</a>.</p>
        </form>
    </section>


    <section id="register" class="d-flex justify-content-center align-items-center container px-5">
        <form action="/admin" method="POST" name="register">
            <h1 class="text-center mb-3 mt-4">Create an account</h1>
            <fieldset>
                <div class="form-group">
                    <label for="name" class="text-20">Full Name<span class="requiredX text-danger"> *</span></label>
                    <input type="name" name="name" class="form-control" id="name" aria-describedby="emailHelp" placeholder="Enter your name" autocapitalize="true" autocomplete="true" autofocus required>
                </div>

                <div class="form-group mt-3">
                    <label for="email" class="text-20">Email address<span class="requiredX text-danger"> *</span></label>
                    <input type="email" name="email" class="mb-2 form-control" id="email" aria-describedby="emailHelp" placeholder="Enter your email" autocomplete="true" required>

                </div>

                <div class="form-group mt-3">
                    <label for="pin" class="text-20">Password<span class="requiredX text-danger"> *</span></label>
                    <input type="password" name="password" class="form-control border" id="pin" aria-describedby="password" placeholder="Enter your password" required>

                    <div class=" passwordHealth w-100">
                        <div class="d-flex align-items-center mt-1 mb-0">
                            <p class="text-success mb-0" style="font-size: 18px;">Strength</p>
                            <small class="ms-4 text-muted mb-0">must include character(s)</small>
                        </div>

                        <div style="height: 18px;" class="w-100 flex align-items-center mt-0">
                            <span class="good border border-1 border-end-0"></span><span class="better border border-1 border-start-0 border-end-0"></span><span class="best border border-1 border-start-0"></span>
                            <small id="infoMsg" style="margin-left: 5%; width: 20%;" class="text-18 text-secondary">Waiting</small>
                        </div>
                    </div>

                </div>
                <div class="form-group mt-3">
                    <label for="confirm-pin" class="text-20">Confirm Password<span class="requiredX text-danger"> *</span></label>
                    <input type="password" name="Cpassword" class="form-control border" id="confirm-pin" aria-describedby="password" placeholder="Enter your password again" required>
                    <small id="errMsg" class="text-danger text-18"></small>
                </div>

                <button type="submit" class="btn btn-primary w-100 mt-4 text-20" name="submit">Submit</button>
            </fieldset>

            <p class="text-center mt-4">Already have an account, <a href="#" class="text-decoration-none border-danger border-bottom border-2 text-pink">Sign in</a>.</p>
        </form>
    </section>

    <%- include('../template/footer')%>
        <script src="/javascripts/bootstrap.min.js"></script>
        <script src="/javascripts/app.js"></script>
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" type="text/javascript"></script> -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
        <script src="/javascripts/jquery.min.js"></script>

        <script>
            function admin(url) {

                const pages = {
                    login: $("#login form"),
                    register: $("#register form")
                };
                $("#register form p>a").click(e => {
                    $("#register").fadeOut(300, () => {
                        pages.login.parent().removeClass("d-none");
                        $("#login").fadeIn(400);
                        pages.register.parent().addClass("d-none");

                    })
                    $("#noUser").text("");
                });
                $("#login form p>a").click(e => {
                    $("#login").fadeOut(300, () => {
                        pages.register.parent().removeClass("d-none");
                        $("#register").fadeIn(400);
                        pages.login.parent().addClass("d-none");
                    })
                    $("#noUser").text("");
                });

                function setCookie(cname, cvalue, exdays) {
                    var d = new Date();
                    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
                    var expires = "expires=" + d.toUTCString();
                    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/admin";
                }

                function getCookie(cname) {
                    var name = cname + "=";
                    var ca = document.cookie.split(';');
                    for (var i = 0; i < ca.length; i++) {
                        var c = ca[i];
                        while (c.charAt(0) == ' ') {
                            c = c.substring(1);
                        }
                        if (c.indexOf(name) == 0) {
                            return c.substring(name.length, c.length);
                        }
                    }
                    return false;
                }
                const fmt1 = /[ `!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~]/,
                    fmt2 = /[a-zA-Z0-9]/,
                    fmt3 = /[0-9]/
                pages.register[0].password.addEventListener("keyup", e => {

                    if (e.target.value.length > 5 && fmt2.test(e.target.value)) {

                        $("#infoMsg").removeClass("text-danger").addClass("text-warning");
                        $(".good").addClass("bg-danger");
                        $(".better").addClass("bg-warning");
                        $(".best").removeClass("bg-success");
                        $("#infoMsg").text("Good");
                        // $(e.target).removeClass("border-danger").addClass("border-warning");

                        if (fmt1.test(e.target.value) === true) {
                            // fmt3.test(e.target.value) === true
                            $("#infoMsg").removeClass("text-warning").addClass("text-success");
                            $(".best").addClass("bg-success");
                            $("#infoMsg").text("Excellent");
                            $(e.target).removeClass("border-danger").addClass("border-success");
                        }

                    } else {
                        $(".better").removeClass("bg-warning");
                        $(".best").removeClass("bg-success");
                        $("#infoMsg").addClass("text-danger").removeClass("text-success");
                        $(".good").addClass("bg-danger");
                        $("#infoMsg").text("Poor");
                        $(e.target).addClass("border-danger")
                    }

                    // if confirm password is not empty
                    if (pages.register[0].Cpassword.value != '') {
                        // and the password matched
                        if (e.target.value === pages.register[0].Cpassword.value) {

                            // remove the red border
                            $(pages.register[0].Cpassword).removeClass("border-danger");
                            // hide error message
                            $("#errMsg").text("");
                            // enable submit button
                            pages.register[0].submit.disabled = false;


                        } else {
                            console.log(document.querySelector("#infoMsg").textContent);
                            // paint border red
                            $(pages.register[0].Cpassword).addClass("border-danger");
                            //  show error message
                            $("#errMsg").text("Password doesn't match!");
                            // disable submit button
                            pages.register[0].submit.disabled = true;
                        }
                    }
                });

                pages.register[0].Cpassword.addEventListener("keyup", e => {

                    if (pages.register[0].password.value != '') {

                        // console.log(e.target.value.indexOf(pass));
                        if (e.target.value === pages.register[0].password.value || e.target.value == '') {

                            if (document.querySelector("#infoMsg").textContent === "Excellent") {
                                $("#errMsg").text("");
                                pages.register[0].submit.disabled = false;
                                $(e.target).removeClass("border-danger").addClass("border-success");
                                console.log(pages.register[0].submit);
                            } else $("#errMsg").html("Your first <b style='cursor:pointer !important'><label for='pin'>password</label></b> strength isn't strong enough");

                        } else {
                            $(e.target).addClass("border-danger");
                            $("#errMsg").text("Password doesn't match!");
                            pages.register[0].submit.disabled = true;
                        }


                    } else {
                        console.log(document.querySelector("#infoMsg").textContent);
                        console.log(e.target.value)
                    }
                });

                pages.register.submit(e => {
                    $("#noUser").text("");
                    const url = $(e)[0].target["action"];
                    console.log(url);
                    e.preventDefault();
                    let data = {
                        name: $(e)[0].target.name.value,
                        email: $(e)[0].target.email.value,
                        password: $(e)[0].target.password.value
                    };
                    $.ajax({
                        type: "POST",
                        url: url,
                        data: data,
                        success: (data) => {
                            if (!data) console.error(data.msg);
                            console.log(data);
                            pages.register.parent().addClass('d-none');
                            pages.login.parent().removeClass("d-none").addClass('d-block');
                        },
                        dataType: "json"
                    });

                    console.log(data);
                });

                pages.login.submit(e => {
                    $("#noUser").removeClass("text-danger").addClass("text-info");
                    $("#noUser").text("Processing your inputs...");
                    const url = $(e)[0].target["action"];
                    console.log(url);
                    e.preventDefault();

                    let info = {
                        email: $(e)[0].target.email.value,
                        password: $(e)[0].target.password.value
                    };

                    try {
                        $.ajax({
                            type: "POST",
                            url: url,
                            data: info,
                            success: (data) => {
                                $("#noUser").removeClass("text-danger");
                                $("#noUser").removeClass("text-info").addClass("text-success");
                                $("#noUser").text("Login successful");
                                document.location.href = `/admin/${info.email}`
                            },
                            error: (err) => {
                                $("#noUser").removeClass("text-info").addClass("text-danger");
                                $("#noUser").text(err.responseJSON.msg)
                            },
                            dataType: "json"
                        })
                    } catch (err) {
                        console.log(err)
                    };

                });

            };

            admin(document.location.href)
        </script>
</body>

</html>